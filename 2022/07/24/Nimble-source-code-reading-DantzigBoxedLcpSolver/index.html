<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/96537531_p0_master1200.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/96537531_p0_master1200.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/96537531_p0_master1200.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"applewonder.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="My first time reading such a large program! Pretty precious memory">
<meta property="og:type" content="article">
<meta property="og:title" content="Nimble source code reading: DantzigBoxedLcpSolver">
<meta property="og:url" content="http://applewonder.github.io/2022/07/24/Nimble-source-code-reading-DantzigBoxedLcpSolver/index.html">
<meta property="og:site_name" content="Always Apple">
<meta property="og:description" content="My first time reading such a large program! Pretty precious memory">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-07-24T05:33:56.000Z">
<meta property="article:modified_time" content="2022-07-24T22:23:10.122Z">
<meta property="article:author" content="Applemandiath">
<meta property="article:tag" content="Nimblephysics">
<meta property="article:tag" content="Machine Learning">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://applewonder.github.io/2022/07/24/Nimble-source-code-reading-DantzigBoxedLcpSolver/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://applewonder.github.io/2022/07/24/Nimble-source-code-reading-DantzigBoxedLcpSolver/","path":"2022/07/24/Nimble-source-code-reading-DantzigBoxedLcpSolver/","title":"Nimble source code reading: DantzigBoxedLcpSolver"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Nimble source code reading: DantzigBoxedLcpSolver | Always Apple</title>
  




<link rel="dns-prefetch" href="blog-waline-server.vercel.app">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Always Apple</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#The-parameter"><span class="nav-number">1.</span> <span class="nav-text">The parameter</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#The-body"><span class="nav-number">2.</span> <span class="nav-text">The body</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Unbounded-Variables"><span class="nav-number">2.1.</span> <span class="nav-text">Unbounded Variables</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prepare-containers"><span class="nav-number">2.2.</span> <span class="nav-text">Prepare containers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Start-Solving"><span class="nav-number">2.3.</span> <span class="nav-text">Start Solving</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Eternal-Loop"><span class="nav-number">2.4.</span> <span class="nav-text">Eternal Loop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Finish-Inner-Loop"><span class="nav-number">2.5.</span> <span class="nav-text">Finish Inner Loop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TaDa-Finish-it"><span class="nav-number">2.6.</span> <span class="nav-text">TaDa! Finish it!</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Conclusion"><span class="nav-number">3.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Applemandiath"
      src="/images/96537531_p0_master1200.jpg">
  <p class="site-author-name" itemprop="name">Applemandiath</p>
  <div class="site-description" itemprop="description">Applemandiath's blog</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://applewonder.github.io/2022/07/24/Nimble-source-code-reading-DantzigBoxedLcpSolver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/96537531_p0_master1200.jpg">
      <meta itemprop="name" content="Applemandiath">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Always Apple">
      <meta itemprop="description" content="Applemandiath's blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Nimble source code reading: DantzigBoxedLcpSolver | Always Apple">
      <meta itemprop="description" content="My first time reading such a large program! Pretty precious memory">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nimble source code reading: DantzigBoxedLcpSolver
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-24 13:33:56" itemprop="dateCreated datePublished" datetime="2022-07-24T13:33:56+08:00">2022-07-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-25 06:23:10" itemprop="dateModified" datetime="2022-07-25T06:23:10+08:00">2022-07-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Experience/" itemprop="url" rel="index"><span itemprop="name">Experience</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline: </span>
  
    <a title="waline" href="/2022/07/24/Nimble-source-code-reading-DantzigBoxedLcpSolver/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2022/07/24/Nimble-source-code-reading-DantzigBoxedLcpSolver/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>11 mins.</span>
    </span>
</div>

            <div class="post-description">My first time reading such a large program! Pretty precious memory</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>The version of the Nimblephysics is still 0.7.7</p>
</blockquote>
<p>This part is about using Dantzig method to solve the LCP problem stated as follow:</p>
<p>find $f,v_{t+1}$</p>
<p>such that $f \geq 0, v_{v+1} \geq 0, f^Tv_{t+1} &#x3D; 0$</p>
<p>$v_{t+1} &#x3D; Af + b$</p>
<blockquote>
<p>Main Code address: dart&#x2F;external&#x2F;odelcpsolver&#x2F;lcp.cpp   </p>
<p>Start from the line 780</p>
</blockquote>
<h1 id="The-parameter"><a href="#The-parameter" class="headerlink" title="The parameter"></a>The parameter</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">dSolveLCP</span> <span class="params">(<span class="type">int</span> n, dReal *A, dReal *x, dReal *b,</span></span></span><br><span class="line"><span class="params"><span class="function">                dReal *outer_w<span class="comment">/*=nullptr*/</span>, <span class="type">int</span> nub, dReal *lo, dReal *hi, <span class="type">int</span> *findex, <span class="type">bool</span> earlyTermination)</span></span></span><br></pre></td></tr></table></figure>

<p>$n$ is the size of $A$, which means $A$ is a $n \times n$ matrix.</p>
<p>$A$ is the above $A$, it should be symmetry and positive definite.</p>
<p>$x$ is the solved $f$</p>
<p>$b$ is the above $b$</p>
<p>$nub$ is the number of unbounded variables</p>
<p>$lo$ and $hi$ is the lower bounds and higher bounds of the $x$</p>
<p>$findex$ is the friction index</p>
<p>$earlyTermination$ is whether not to use PGS algorithm</p>
<h1 id="The-body"><a href="#The-body" class="headerlink" title="The body"></a>The body</h1><h2 id="Unbounded-Variables"><a href="#Unbounded-Variables" class="headerlink" title="Unbounded Variables"></a>Unbounded Variables</h2><blockquote>
<p>Only when $nub \geq n$ can this process be activated.</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nub &gt;= n) &#123;</span><br><span class="line">    dReal *d = <span class="keyword">new</span> dReal[n];</span><br><span class="line">    <span class="built_in">dSetZero</span> (d, n);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> nskip = <span class="built_in">dPAD</span>(n);</span><br><span class="line">    <span class="built_in">dFactorLDLT</span> (A, d, n, nskip);</span><br><span class="line">    <span class="built_in">dSolveLDLT</span> (A, d, b, n, nskip);</span><br><span class="line">    <span class="built_in">memcpy</span> (x, b, n*<span class="built_in">sizeof</span>(dReal));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>[] d;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>The process is mainly about:<br>$$<br>A &#x3D; LDL^T\<br>x &#x3D; A^{-1}b &#x3D; L^{-T}D^{-1}L^{-1}b<br>$$<br>The $b$ in the above parameter might be $-b$.</p>
<p>##Lo-Hi LCP</p>
<h2 id="Prepare-containers"><a href="#Prepare-containers" class="headerlink" title="Prepare containers"></a>Prepare containers</h2><p>Unfortunately, usually the $nub$ is $0$. So we have to </p>
<p>Things we need:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">dLCP <span class="title">lcp</span><span class="params">(n,nskip,nub,A,x,b,w,lo,hi,L,d,Dell,ell,delta_w,state,findex,p,C,Arows)</span></span>;</span><br></pre></td></tr></table></figure>

<p>These new parameters are all constructed by <code>new</code>.</p>
<p>Let’s dive into its constructor and see what happened:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dLCP::<span class="built_in">dLCP</span> (<span class="type">int</span> _n, <span class="type">int</span> _nskip, <span class="type">int</span> _nub, dReal *_Adata, dReal *_x, dReal *_b, dReal *_w, dReal *_lo, dReal *_hi, dReal *_L, dReal *_d, dReal *_Dell, dReal *_ell, dReal *_tmp, <span class="type">bool</span> *_state, <span class="type">int</span> *_findex, <span class="type">int</span> *_p, <span class="type">int</span> *_C, dReal **Arows)</span><br></pre></td></tr></table></figure>

<p>The <code>dLCP</code> is actually a struct, and the family variables are:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> m_n;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> m_nskip;</span><br><span class="line"><span class="type">int</span> m_nub;</span><br><span class="line"><span class="type">int</span> m_nC, m_nN;				<span class="comment">// size of each index set</span></span><br><span class="line">ATYPE <span class="type">const</span> m_A;				<span class="comment">// A rows //ATYPE is dReal **</span></span><br><span class="line">dReal *<span class="type">const</span> m_x, * <span class="type">const</span> m_b, *<span class="type">const</span> m_w, *<span class="type">const</span> m_lo,* <span class="type">const</span> m_hi;	<span class="comment">// permuted LCP problem data</span></span><br><span class="line">dReal *<span class="type">const</span> m_L, *<span class="type">const</span> m_d;				<span class="comment">// L*D*L&#x27; factorization of set C</span></span><br><span class="line">dReal *<span class="type">const</span> m_Dell, *<span class="type">const</span> m_ell, *<span class="type">const</span> m_tmp;</span><br><span class="line"><span class="type">bool</span> *<span class="type">const</span> m_state;</span><br><span class="line"><span class="type">int</span> *<span class="type">const</span> m_findex, *<span class="type">const</span> m_p, *<span class="type">const</span> m_C;</span><br></pre></td></tr></table></figure>

<p>Basically, it just puts these parameters in corresponding family variables. Besides, all unbounded rows and columns shall be swapped to the first $nub$ rows and columns. And <code>p</code> will record the new permutation.</p>
<p>Understand this, we could know what is the <code>adj_nub</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> adj_nub = lcp.<span class="built_in">getNub</span>();<span class="comment">// sdj_nub = m_nub</span></span><br></pre></td></tr></table></figure>

<p>From the above code, <code>m_code</code> is <code>nub</code>, which is the number of unbounded variables. Actually, if <code>nub</code> greater than $0$, depending on the constructor:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> nub = m_nub;</span><br><span class="line">&#123;</span><br><span class="line">    dReal *Lrow = m_L;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> nskip = m_nskip;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">0</span>; j&lt;nub; Lrow+=nskip, ++j) <span class="built_in">memcpy</span>(Lrow,<span class="built_in">AROW</span>(j),(j+<span class="number">1</span>)*<span class="built_in">sizeof</span>(dReal));</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">dFactorLDLT</span> (m_L,m_d,nub,m_nskip);</span><br><span class="line"><span class="built_in">memcpy</span> (m_x,m_b,nub*<span class="built_in">sizeof</span>(dReal));</span><br><span class="line"><span class="built_in">dSolveLDLT</span> (m_L,m_d,m_x,nub,m_nskip);</span><br><span class="line"><span class="built_in">dSetZero</span> (m_w,nub);</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> *C = m_C;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> k=<span class="number">0</span>; k&lt;nub; ++k) C[k] = k;</span><br><span class="line">&#125;</span><br><span class="line">m_nC = nub;</span><br></pre></td></tr></table></figure>

<p>It is quite familiar to us. These codes solve a $nub \times nub$ matrix embedded in $A$ and save the results in the $m_x$. Of course, only the first $nub$ variables in the $m_x$.</p>
<blockquote>
<p>Keep in mind that the current $x$ is all normal forces!!!</p>
</blockquote>
<h2 id="Start-Solving"><a href="#Start-Solving" class="headerlink" title="Start Solving"></a>Start Solving</h2><p>Now here is where the dream started:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=adj_nub; i&lt;n; ++i)</span><br></pre></td></tr></table></figure>

<p>This loop will finish the computation of these bounded questions. </p>
<blockquote>
<p>The author’s words:</p>
<p>Loop over all indexes adj_nub..n-1. For index $i$, if $x(i),w(i)$ satisfy the LCP conditions then $i$ is added to the appropriate index set. Otherwise, $x(i),w(i)$ is driven either $+ve$ or $-ve$ to force it to the valid region. As we drive $x(i), x(C)$ is also adjusted to keep $w(C)$ at zero. While driving $x(i)$ we maintain the LCP conditions on the other variables $0..i-1$. We do this by watching out for other $x(i),w(i)$ values going outside the valid region, and then switching them between index sets when that happens.</p>
</blockquote>
<blockquote>
<p>The index i is the driving index and indexes i+1..n-1 are “don’t care”, i.e. When we make changes to the system those x’s will be zero and we don’t care what happens to those w’s. In other words, we only consider an $(i+1)<em>(i+1)$ sub-problem of $A</em>x&#x3D;b+w$.</p>
</blockquote>
<p>Remember, the algorithm goes from $A[0][0],  A[i][i]$, to $A[n][n]$.</p>
<p>Why  $A*x&#x3D;b+w$???</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> hit_first_friction_index = <span class="literal">false</span>;<span class="comment">//this line is in the outside of the loop!!!</span></span><br></pre></td></tr></table></figure>

<p>This bool variable is used to control to initialize the $lo$ and $hi$ constraints:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">0</span>; j&lt;n; ++j) delta_w[p[j]] = x[j]; <span class="comment">//unpermuted the answer x to make the findex valid</span></span><br><span class="line"><span class="comment">//x is the F_N</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// set lo and hi values</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> k=i; k&lt;n; ++k) &#123;</span><br><span class="line">    dReal wfk = delta_w[findex[k]];</span><br><span class="line">    <span class="keyword">if</span> (wfk == <span class="number">0</span>) &#123;<span class="comment">//the contact force is 0</span></span><br><span class="line">        hi[k] = <span class="number">0</span>;</span><br><span class="line">        lo[k] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        hi[k] = <span class="built_in">dFabs</span> (hi[k] * wfk);<span class="comment">//turn it to be the type &#x27;double&#x27; //F_N * f_e</span></span><br><span class="line">        lo[k] = -hi[k];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The author’s words:</p>
<p>If we’ve hit the first friction index, we have to compute the $lo$ and $hi$ values based on the values of $x$ already computed. we have been permuting the indexes, so the values stored in the $findex$ vector are no longer valid. thus we have to temporarily unpermute the $x$ vector. for the purposes of this computation, $0*\infty &#x3D; 0$ … so if the contact constraint’s normal force is $0$, there should be no tangential force applied.</p>
</blockquote>
<p>Because of the existence of <code>hit_first_friction_index</code>, the above process could only be executed once.</p>
<p>Now we initialize the $Lo$ and $Hi$, giving bounds to the tangential forces.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool s_error = false;</span><br></pre></td></tr></table></figure>

<p>This bool variable is aimed at killing the loop, when the $s$ is negtive, which is illegal.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w[i] = lcp.<span class="built_in">AiC_times_qC</span> (i,x) + lcp.<span class="built_in">AiN_times_qN</span> (i,x) - b[i];</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The author’s words:</p>
<p>Thus far we have not even been computing the $w$ values for indexes greater than $i$, so compute $w[i]$ now.</p>
</blockquote>
<p>This line of code is:<br>$$<br>\begin{align}<br>w_i &amp;&#x3D; A_{i(0C)}*x_{0C} + A_{i(C\ C+N)}*x_{C\ (C+N)} - b[i] \<br>&amp;&#x3D; A_{i(0(C+N))}*x_{0(C+N)} - b[i]<br>\end{align}	<br>$$<br>So :<br>$$<br>w &#x3D; A_{n\ C+N}*x - b<br>$$</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for i in N, state[i] is 0 if x(i)==lo(i) or 1 if x(i)==hi(i)</span></span><br><span class="line"><span class="type">bool</span> *state = <span class="keyword">new</span> <span class="type">bool</span>[n];</span><br></pre></td></tr></table></figure>

<p>Definition of the $state$</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lo[i]==<span class="number">0</span> &amp;&amp; w[i] &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    lcp.<span class="built_in">transfer_i_to_N</span> (i);</span><br><span class="line">    state[i] = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (hi[i]==<span class="number">0</span> &amp;&amp; w[i] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    lcp.<span class="built_in">transfer_i_to_N</span> (i);</span><br><span class="line">    state[i] = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Weird… Why $w[i] \geq 0\ &amp;\ Lo[i]$ means that $x[i] &#x3D; 0$? Same question to the $Hi[n]$. </p>
<p>$x[i] &#x3D; 0$, so $i$ in $N$.</p>
<blockquote>
<p>The author’s words:</p>
<p>If $Lo&#x3D;Hi&#x3D;0$ (which can happen for tangential friction when normals are $0$. Then the index will be assigned to set $N$ with some state. However, set $C$’s line has zero sizes, so the index will always remain in set $N$. With the “normal” switching logic, if $w$ changed sign then the index would have to switch to set $C$ and then back to set $N$ with an inverted state. This is pointless, and also computationally expensive. To prevent this from happening, we use the rule that indexes with $Lo&#x3D;Hi&#x3D;0$ will never be checked for set changes. This means that the state for these indexes may be incorrect, but that doesn’t matter.</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (w[i]==<span class="number">0</span>) &#123;</span><br><span class="line">    lcp.<span class="built_in">solve1</span> (delta_x,i,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    lcp.<span class="built_in">transfer_i_to_C</span> (i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this state, $Lo[i] &lt; 0 &#x3D; w[i] &#x3D; 0 &lt; Hi[i]$.</p>
<p>$w[i] &#x3D; (Af(or\ x)-b)[i] &#x3D; 0$, $i$ in $C$.</p>
<p>Now we only have two instances:<br>$$<br>w[i] &gt; 0\ &amp;\ Lo[i] &lt; 0   \<br>w[i] &lt; 0\ &amp;\ Hi[i] &gt; 0<br>$$<br>Both situations $w*x \neq 0$, so we need to do our job.</p>
<h2 id="Eternal-Loop"><a href="#Eternal-Loop" class="headerlink" title="Eternal Loop"></a>Eternal Loop</h2><p>The code used a permanent loop to adjust the answer until the sets $C$ and $N$ are not changing.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> dir;</span><br><span class="line">dReal dirf;</span><br><span class="line"><span class="keyword">if</span> (w[i] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    dir = <span class="number">1</span>;</span><br><span class="line">    dirf = <span class="built_in">REAL</span>(<span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    dir = <span class="number">-1</span>;</span><br><span class="line">    dirf = <span class="built_in">REAL</span>(<span class="number">-1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The author’s words:</p>
<p>Find direction to push on $x(i)$.</p>
</blockquote>
<p>As you can see, when $w[i] &lt; 0$, $x[i]$ must increase to let $w[i] &#x3D; 0$, so the direction should be $1$. The opposite is the same reason.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcp.<span class="built_in">solve1</span> (delta_x,i,dir);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The author’s word:</p>
<p>compute: delta_x(C) &#x3D; -dir*A(C,C)\A(C,i).</p>
</blockquote>
<p>I believe it should correspond to the pseudo-code <em>dfirection</em> in the paper <a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~baraff/papers/sig94.pdf">Fast Contact Force Computation for Nonpenetrating Rigid Bodies</a>, and:<br>$$<br>delta_x &#x3D; -A_{CC}^{-1}A_{Ci}<br>$$</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lcp.<span class="built_in">pN_equals_ANC_times_qC</span> (delta_w,delta_x);<span class="comment">//delta_w[N] = A[N]*delta_x</span></span><br><span class="line">lcp.<span class="built_in">pN_plusequals_ANi</span> (delta_w,i,dir);<span class="comment">//delta_w[N] += dir*A[i][N]</span></span><br><span class="line">delta_w[i] = lcp.<span class="built_in">AiC_times_qC</span> (i,delta_x) + lcp.<span class="built_in">Aii</span>(i)*dirf;</span><br><span class="line"><span class="comment">//delta_w[i] = A[i][C]*delta_x[C] + dir*A[i][i]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>The author’s words:</p>
<p>Compute: delta_w &#x3D; A*delta_x … note we only care about delta_w(N) and delta_w(i), the rest is ignored</p>
</blockquote>
<p>Still, this part corresponds to $\Delta a &#x3D; A \Delta f$.</p>
<p>Now we step into the process to culculate the largest step $s$.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int cmd = 1;		// index switching command</span><br><span class="line">int si = 0;		// si = index to switch if cmd&gt;3</span><br></pre></td></tr></table></figure>

<p>Used to deal with different situations.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dReal s = -w[i]/delta_w[i];</span><br></pre></td></tr></table></figure>

<p>$s$ is used to record the maximum step.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (dir &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hi[i] &lt; dInfinity) &#123;</span><br><span class="line">        dReal s2 = (hi[i]-x[i])*dirf;	<span class="comment">// was (hi[i]-x[i])/dirf	</span></span><br><span class="line">        <span class="comment">// step to x(i)=hi(i)</span></span><br><span class="line">        <span class="keyword">if</span> (s2 &lt; s) &#123;</span><br><span class="line">            s = s2;</span><br><span class="line">            cmd = <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">// try yout best to achieve higher bound</span></span><br><span class="line"><span class="comment">//situation 3</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lo[i] &gt; -dInfinity) &#123;</span><br><span class="line">        dReal s2 = (lo[i]-x[i])*dirf;	<span class="comment">// was (lo[i]-x[i])/dirf	</span></span><br><span class="line">        <span class="comment">// step to x(i)=lo(i)</span></span><br><span class="line">        <span class="keyword">if</span> (s2 &lt; s) &#123;</span><br><span class="line">            s = s2;</span><br><span class="line">            cmd = <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">// try yout best to achieve lower bound</span></span><br><span class="line"><span class="comment">//situation 2</span></span><br></pre></td></tr></table></figure>

<p>Really simple code…</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> numN = lcp.<span class="built_in">numN</span>();<span class="comment">//x should be 0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> k=<span class="number">0</span>; k &lt; numN; ++k) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> indexN_k = lcp.<span class="built_in">indexN</span>(k);</span><br><span class="line">        <span class="keyword">if</span> (!state[indexN_k] ? delta_w[indexN_k] &lt; <span class="number">0</span> : delta_w[indexN_k] &gt; <span class="number">0</span>) </span><br><span class="line">        <span class="comment">//have no idea why they need this judjement</span></span><br><span class="line">        </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// don&#x27;t bother checking if lo=hi=0</span></span><br><span class="line">            <span class="keyword">if</span> (lo[indexN_k] == <span class="number">0</span> &amp;&amp; hi[indexN_k] == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            dReal s2 = -w[indexN_k] / delta_w[indexN_k];</span><br><span class="line">            <span class="keyword">if</span> (s2 &lt; s) &#123;</span><br><span class="line">                s = s2;</span><br><span class="line">                cmd = <span class="number">4</span>;</span><br><span class="line">                si = indexN_k;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//situation 4</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> numC = lcp.<span class="built_in">numC</span>();<span class="comment">//w should be 0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> k=adj_nub; k &lt; numC; ++k) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> indexC_k = lcp.<span class="built_in">indexC</span>(k);</span><br><span class="line">        <span class="keyword">if</span> (delta_x[indexC_k] &lt; <span class="number">0</span> &amp;&amp; lo[indexC_k] &gt; -dInfinity) &#123;</span><br><span class="line">            dReal s2 = (lo[indexC_k]-x[indexC_k]) / delta_x[indexC_k];</span><br><span class="line">            <span class="keyword">if</span> (s2 &lt; s) &#123;</span><br><span class="line">                s = s2;</span><br><span class="line">                cmd = <span class="number">5</span>;</span><br><span class="line">                si = indexC_k;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="comment">//situation 5</span></span><br><span class="line">        <span class="keyword">if</span> (delta_x[indexC_k] &gt; <span class="number">0</span> &amp;&amp; hi[indexC_k] &lt; dInfinity) &#123;</span><br><span class="line">            dReal s2 = (hi[indexC_k]-x[indexC_k]) / delta_x[indexC_k];</span><br><span class="line">            <span class="keyword">if</span> (s2 &lt; s) &#123;</span><br><span class="line">                s = s2;</span><br><span class="line">                cmd = <span class="number">6</span>;</span><br><span class="line">                si = indexC_k;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="comment">//situation 6</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Need to judge whether the step is broken:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (s &lt;= <span class="built_in">REAL</span>(<span class="number">0.0</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (earlyTermination) &#123;<span class="comment">//We get PGS!! Go away, Danzig</span></span><br><span class="line">            <span class="keyword">if</span> (!outer_w) <span class="keyword">delete</span>[] w;</span><br><span class="line">        <span class="keyword">delete</span>[] L;</span><br><span class="line">        <span class="keyword">delete</span>[] d;</span><br><span class="line">        <span class="keyword">delete</span>[] delta_w;</span><br><span class="line">        <span class="keyword">delete</span>[] delta_x;</span><br><span class="line">        <span class="keyword">delete</span>[] Dell;</span><br><span class="line">        <span class="keyword">delete</span>[] ell;</span><br><span class="line">        <span class="meta">#<span class="keyword">ifdef</span> ROWPTRS</span></span><br><span class="line">        <span class="keyword">delete</span>[] Arows;</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">delete</span>[] p;</span><br><span class="line">        <span class="keyword">delete</span>[] C;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">delete</span>[] state;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We shouldn&#x27;t be overly aggressive about printing this warning,</span></span><br><span class="line">    <span class="comment">// because sometimes it gets spammed if s is just a tiny bit beneath</span></span><br><span class="line">    <span class="comment">// 0.0.</span></span><br><span class="line">    <span class="keyword">if</span> (s &lt; <span class="built_in">REAL</span>(<span class="number">-1e-6</span>)) &#123;</span><br><span class="line">        <span class="built_in">dMessage</span> (d_ERR_LCP, <span class="string">&quot;LCP internal error, s &lt;= 0 (s=%.4e)&quot;</span>,</span><br><span class="line">        (<span class="type">double</span>)s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &lt; n) &#123;</span><br><span class="line">        <span class="built_in">dSetZero</span> (x+i,n-i);<span class="comment">//bye-bye, our efforts are totally in vain </span></span><br><span class="line">        <span class="built_in">dSetZero</span> (w+i,n-i);<span class="comment">//bye-bye, our efforts are totally in vain </span></span><br><span class="line">    &#125;</span><br><span class="line">    s_error = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Plus these step and direction to $x$ and $w$.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// apply x = x + s * delta_x</span></span><br><span class="line">lcp.<span class="built_in">pC_plusequals_s_times_qC</span> (x, s, delta_x);</span><br><span class="line">x[i] += s * dirf;</span><br><span class="line"></span><br><span class="line"><span class="comment">// apply w = w + s * delta_w</span></span><br><span class="line">lcp.<span class="built_in">pN_plusequals_s_times_qN</span> (w, s, delta_w);</span><br><span class="line">w[i] += s * delta_w[i];</span><br></pre></td></tr></table></figure>

<p>$$<br>x[C] +&#x3D;\ s<em>delta_x[C]\<br>x[i] +&#x3D;\ s</em>dir\<br>w[N] +&#x3D;\ s<em>delta_w[N]\<br>w[i] +&#x3D;\ s</em>dir\<br>$$</p>
<p> Since we get the maximum step length $s$, it is time to move these indexes.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">1</span>:		<span class="comment">// done</span></span><br><span class="line">    w[i] = <span class="number">0</span>;</span><br><span class="line">    lcp.<span class="built_in">transfer_i_to_C</span> (i);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>cmd is $1$, which means $ s &#x3D; -w[i]&#x2F;delta_w[i]$.  $w[i] &#x3D; 0$, so $i$ should in $C$.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2</span>:		<span class="comment">// done</span></span><br><span class="line">    x[i] = lo[i];</span><br><span class="line">    state[i] = <span class="literal">false</span>;</span><br><span class="line">    lcp.<span class="built_in">transfer_i_to_N</span> (i);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>cmd is 2, which means $s &#x3D; (lo[i]-x[i])*dirf$. $x[i] &#x3D; 0$,  so $i$ should in $N$.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">3</span>:		<span class="comment">// done</span></span><br><span class="line">    x[i] = hi[i];</span><br><span class="line">    state[i] = <span class="literal">true</span>;</span><br><span class="line">    lcp.<span class="built_in">transfer_i_to_N</span> (i);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>cmd is 3, which means $s &#x3D; (hi[i]-x[i])*dirf$. $x[i] &#x3D; 0$,  so $i$ should in $N$.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">4</span>:		<span class="comment">// keep going</span></span><br><span class="line">    w[si] = <span class="number">0</span>;</span><br><span class="line">    lcp.<span class="built_in">transfer_i_from_N_to_C</span> (si);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>cmd is 4, which means $s &#x3D; -w[indexN_k] &#x2F; delta_w[indexN_k]$. $w[si] &#x3D; 0$,  so $si$ should transfer from $N$ to $C$.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">5</span>:		<span class="comment">// keep going</span></span><br><span class="line">    x[si] = lo[si];</span><br><span class="line">    state[si] = <span class="literal">false</span>;</span><br><span class="line">    lcp.<span class="built_in">transfer_i_from_C_to_N</span> (si, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>cmd is 5, which means $s &#x3D; (lo[indexC_k]-x[indexC_k]) &#x2F; delta_x[indexC_k]$. $x[si] &#x3D; 0$,  so $si$ should transfer from $C$ to $N$.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">6</span>:		<span class="comment">// keep going</span></span><br><span class="line">    x[si] = hi[si];</span><br><span class="line">    state[si] = <span class="literal">true</span>;</span><br><span class="line">    lcp.<span class="built_in">transfer_i_from_C_to_N</span> (si, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>cmd is 6, which means $s &#x3D; (hi[indexC_k]-x[indexC_k]) &#x2F; delta_x[indexC_k]$. $x[si] &#x3D; 0$,  so $si$ should transfer from $C$ to $N$.</p>
<p>If the $cmd \leq3$, this means the set $N$ and $C$ are all stable, we could be saved from the while(true) loop.</p>
<h2 id="Finish-Inner-Loop"><a href="#Finish-Inner-Loop" class="headerlink" title="Finish Inner Loop"></a>Finish Inner Loop</h2><p>Note that if $s_error &#x3D; true$, we need break from the main loop right now:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (s_error) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="TaDa-Finish-it"><a href="#TaDa-Finish-it" class="headerlink" title="TaDa! Finish it!"></a>TaDa! Finish it!</h2><p>When everything is done, we need to upermute the $x$ and $w$:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lcp.<span class="built_in">unpermute</span>();</span><br></pre></td></tr></table></figure>

<p>and delete everything, return true:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!outer_w)</span><br><span class="line">          <span class="keyword">delete</span>[] w;</span><br><span class="line">    <span class="keyword">delete</span>[] L;</span><br><span class="line">    <span class="keyword">delete</span>[] d;</span><br><span class="line">    <span class="keyword">delete</span>[] delta_w;</span><br><span class="line">    <span class="keyword">delete</span>[] delta_x;</span><br><span class="line">    <span class="keyword">delete</span>[] Dell;</span><br><span class="line">    <span class="keyword">delete</span>[] ell;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ROWPTRS</span></span><br><span class="line">  	<span class="keyword">delete</span>[] Arows;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">delete</span>[] p;</span><br><span class="line">	<span class="keyword">delete</span>[] C;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span>[] state;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>It takes me two weeks to realize what is going on in this function. Really nice experience about reading a giant program. It is my first time reading these things ^_^. </p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Nimblephysics/" rel="tag"># Nimblephysics</a>
              <a href="/tags/Machine-Learning/" rel="tag"># Machine Learning</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/07/11/Build-a-Compiler-from-Scratch-IR-Generate/" rel="prev" title="Build-a-Compiler-from-Scratch(IR Generate)">
                  <i class="fa fa-chevron-left"></i> Build-a-Compiler-from-Scratch(IR Generate)
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Applemandiath</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Symbols count total: </span>
    <span title="Symbols count total">16k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">15 mins.</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.1/es5/tex-mml-chtml.js","integrity":"sha256-hlC2uSQYTmPsrzGZTEQEg9PZ1a/+SV6VBCTclohf2og="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"blog-waline-server.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"Hello","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":false,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2022/07/24/Nimble-source-code-reading-DantzigBoxedLcpSolver/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
